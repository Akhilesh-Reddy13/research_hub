"""
Agent 3: PDF Generator Tool
-------------------------------
Generates a polished storyboard PDF using ReportLab.
Includes title page, summary, and scene-by-scene layout with images.
"""

import os
from reportlab.lib import colors
from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import inch, cm
from reportlab.platypus import (
    SimpleDocTemplate,
    Paragraph,
    Spacer,
    Image as RLImage,
    PageBreak,
    Table,
    TableStyle,
    HRFlowable,
)

PDF_DIR = os.path.join(os.path.dirname(os.path.dirname(__file__)), "generated_pdfs")
os.makedirs(PDF_DIR, exist_ok=True)


def _build_styles():
    """Custom paragraph styles for the storyboard PDF."""
    styles = getSampleStyleSheet()

    styles.add(ParagraphStyle(
        "StoryTitle",
        parent=styles["Title"],
        fontSize=28,
        leading=34,
        textColor=colors.HexColor("#1a1a2e"),
        spaceAfter=20,
    ))
    styles.add(ParagraphStyle(
        "Subtitle",
        parent=styles["Normal"],
        fontSize=13,
        textColor=colors.HexColor("#6c63ff"),
        spaceAfter=30,
    ))
    styles.add(ParagraphStyle(
        "SceneTitle",
        parent=styles["Heading2"],
        fontSize=16,
        textColor=colors.HexColor("#6c63ff"),
        spaceBefore=14,
        spaceAfter=8,
    ))
    styles.add(ParagraphStyle(
        "SceneDesc",
        parent=styles["Normal"],
        fontSize=10,
        textColor=colors.HexColor("#555555"),
        spaceAfter=6,
        italic=True,
    ))
    styles.add(ParagraphStyle(
        "Narration",
        parent=styles["Normal"],
        fontSize=11,
        leading=16,
        textColor=colors.HexColor("#222222"),
        spaceAfter=16,
    ))
    styles.add(ParagraphStyle(
        "SummaryText",
        parent=styles["Normal"],
        fontSize=11,
        leading=16,
        textColor=colors.HexColor("#333333"),
        spaceAfter=12,
    ))

    return styles


def generate_pdf(
    summary: str,
    scenes: list[dict],
    image_paths: list[str | None],
    session_id: str,
) -> str:
    """Build the storyboard PDF and return the file path."""
    filename = os.path.join(PDF_DIR, f"storyboard_{session_id}.pdf")
    doc = SimpleDocTemplate(
        filename,
        pagesize=A4,
        leftMargin=1.2 * cm,
        rightMargin=1.2 * cm,
        topMargin=1.5 * cm,
        bottomMargin=1.5 * cm,
    )
    styles = _build_styles()
    elements = []

    # ── Title page ──
    elements.append(Spacer(1, 2 * inch))
    elements.append(Paragraph("Research Storyboard", styles["StoryTitle"]))
    elements.append(Paragraph("Generated by ResearchHub AI", styles["Subtitle"]))
    elements.append(Spacer(1, 0.5 * inch))
    elements.append(HRFlowable(width="80%", thickness=1, color=colors.HexColor("#6c63ff")))
    elements.append(Spacer(1, 0.3 * inch))

    # Summary section
    elements.append(Paragraph("Research Summary", styles["Heading1"]))
    elements.append(Spacer(1, 6))
    # Split long summary into paragraphs for better readability
    for para in summary.split("\n"):
        para = para.strip()
        if para:
            elements.append(Paragraph(para, styles["SummaryText"]))
    elements.append(PageBreak())

    # ── Scene pages ──
    for i, scene in enumerate(scenes):
        scene_num = i + 1
        title = scene.get("scene_title", f"Scene {scene_num}")
        description = scene.get("description", "")
        narration = scene.get("narration", description)

        elements.append(Paragraph(f"Scene {scene_num}: {title}", styles["SceneTitle"]))
        elements.append(HRFlowable(width="100%", thickness=0.5, color=colors.HexColor("#e0e0e0")))
        elements.append(Spacer(1, 8))

        # Image
        img_path = image_paths[i] if i < len(image_paths) else None
        if img_path and os.path.exists(img_path):
            try:
                img = RLImage(img_path, width=6 * inch, height=4 * inch, kind="proportional")
                elements.append(img)
                elements.append(Spacer(1, 10))
            except Exception as e:
                print(f"[PDF] Failed to embed image for scene {scene_num}: {e}")

        # Description
        if description:
            elements.append(Paragraph(f"<i>{description}</i>", styles["SceneDesc"]))

        # Narration
        elements.append(Paragraph(narration, styles["Narration"]))

        if scene_num < len(scenes):
            elements.append(Spacer(1, 10))
            elements.append(HRFlowable(width="40%", thickness=0.5, color=colors.HexColor("#cccccc")))
            elements.append(Spacer(1, 10))

    # Build PDF
    doc.build(elements)
    return filename
